<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1162/1162456.png">
    <title>V12 | IHVH FINNO PAY</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { 
            --active-orange: #ff6b00; 
            --deep-orange: #e65f00;
            --gov-bg: #f8fafc;
        }
        
        body { 
            background: var(--gov-bg); 
            font-family: 'Inter', sans-serif; 
            color: #334155; 
        }

        /* Anima√ß√µes e Efeitos V12 */
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(400%); }
        }
        .animate-scan { animation: scan 2s linear infinite; }
        
        button:active {
            box-shadow: inset 0 0 20px rgba(234, 88, 12, 0.6);
            transform: scale(0.98);
        }

        .font-gold {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.2em;
            color: #fcd34d;
        }

        .v12-logo-3d {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 8px 8px 16px #070a11, -8px -8px 16px #1e293b;
            color: #ea580c;
            font-weight: 900;
            padding: 20px 40px;
            border-radius: 20px;
            border: 1px solid rgba(234, 88, 12, 0.2);
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(234, 88, 12, 0.5);
        }

        .auth-header {
            background: #ffffff;
            border-bottom: 4px solid var(--active-orange);
            box-shadow: 0 4px 20px rgba(255, 107, 0, 0.15);
        }

        .panel-3d { 
            background: #ffffff; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }
        
        .input-tactical {
            border: 2px solid #e2e8f0; padding: 14px; border-radius: 10px;
            font-weight: 700; transition: all 0.3s;
            background: #fdfdfd;
        }
        .input-tactical:focus { 
            border-color: var(--active-orange); 
            background: #fff; 
            box-shadow: 0 0 0 4px rgba(255, 107, 0, 0.1);
            outline: none; 
        }

        .terminal-log {
            background: #1e293b; color: #fb923c;
            font-family: 'JetBrains Mono', monospace; font-size: 11px;
            padding: 15px; border-radius: 12px; border: 2px solid #334155;
        }

        .btn-orange {
            background: linear-gradient(180deg, #ff8a33 0%, #ff6b00 100%);
            border-bottom: 4px solid #b34b00;
            transition: all 0.1s;
        }
        .btn-orange:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
        }

        #reader { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 20px; display: none; }

        .ai-status-pulse { animation: pulse-ai 2s infinite; }
        @keyframes pulse-ai {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .prophetic-alert {
            background: linear-gradient(90deg, #0f172a 0%, #334155 100%);
            border-left: 4px solid #f97316;
        }

        /* --- MOTOR DE IMPRESS√ÉO CSS --- */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                display: block !important; 
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="auth-gate" class="fixed inset-0 min-h-screen flex items-center justify-center bg-[#0a0f1a] p-4 z-[10000]">
    <div class="bg-slate-900/90 backdrop-blur-md p-8 md:p-12 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.5)] w-full max-w-[450px] border border-slate-700/50 text-center">
        <div class="v12-logo-3d inline-block mb-10 text-orange-500 font-black text-4xl tracking-tighter">V12</div>
        <h2 class="text-3xl font-bold text-white uppercase italic mb-2">Acesse</h2>
        <p class="text-orange-500 text-[10px] font-bold mb-8 tracking-[0.4em] uppercase">Yod He Vav He</p>
        
        <div class="space-y-4">
            <input type="email" id="v12_email" placeholder="E-mail de Autoridade" 
                   class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-2xl text-white outline-none focus:border-orange-500 transition-all">
            <input type="password" id="v12_pass" placeholder="Senha Criptogr√°fica" 
                   class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-2xl text-white outline-none focus:border-orange-500 transition-all">
            
            <button onclick="checkV12Auth()" 
                    class="w-full bg-orange-600 hover:bg-orange-500 text-white font-black py-4 rounded-2xl shadow-lg transition-all active:scale-95 uppercase tracking-widest">
                Iniciar Sincroniza√ß√£o
            </button>
            <p class="text-[11px] text-slate-500 mt-6 cursor-pointer hover:text-orange-500 font-black uppercase tracking-widest transition-all" 
               onclick="solicitarCadastro()">Solicitar Credenciais</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mt-6">
            <div class="p-4 bg-slate-900 rounded-xl border border-emerald-500/30">
                <p class="text-[9px] text-slate-500 uppercase">Status</p>
                <p class="text-emerald-400 font-black tracking-widest text-[10px]">‚óè OPERACIONAL</p>
            </div>
            <div class="p-4 bg-slate-900 rounded-xl border border-blue-500/30">
                <p class="text-[9px] text-slate-500 uppercase">WhatsApp</p>
                <p class="text-blue-400 font-black tracking-widest text-[10px]">‚óè SINCRONIZADO</p>
            </div>
        </div>
    </div>
</div>

<div class="no-print">
    <div id="offlineBadge" class="fixed top-0 left-0 right-0 bg-orange-600 text-white text-center py-1.5 text-xs font-black uppercase tracking-widest z-50 hidden">
        CONTING√äNCIA OFFLINE
    </div>

    <header class="auth-header p-6 flex justify-between items-center bg-white border-b border-slate-100 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="v12-logo-3d bg-slate-900 text-white font-black p-3 rounded-xl shadow-lg transform rotate-3 hover:rotate-0 transition-transform cursor-default" style="font-size: 1.5rem; padding: 10px 20px;">
                V12
            </div>
            <div>
                <h1 class="text-3xl font-black tracking-tighter uppercase text-slate-900">
                    <span class="text-orange-600">IHVH</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[11px] font-bold bg-slate-800 text-white px-2 py-0.5 rounded tracking-widest uppercase">FINNO PAY</span>
                    <span id="network-badge" class="text-[11px] font-bold bg-orange-100 text-orange-700 px-2 py-0.5 rounded italic animate-pulse">
                        üõ∞Ô∏è BUSCANDO REDE...
                    </span>
                </div>
            </div>
        </div>
        <div class="hidden md:flex items-center gap-4 text-right">
            <div id="statusHw" class="bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-200 flex items-center gap-3">
                <span class="w-3 h-3 bg-emerald-500 rounded-full animate-ping"></span>
                <span class="text-[11px] font-black uppercase text-emerald-600" id="statusAssinador">Sistema Ativo</span>
            </div>
            <div>
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Acesso de Autoridade</p>
                <p class="text-xs font-bold text-slate-800">$P2</p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        <div class="prophetic-alert p-6 rounded-2xl flex items-center justify-between shadow-[10px_10px_30px_#070a11] bg-slate-900 border border-slate-800">
            <div class="flex items-center gap-6">
                <div class="bg-orange-600 p-3 rounded-xl ai-status-pulse shadow-[0_0_15px_rgba(234,88,12,0.4)]">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-[10px] font-black text-orange-500 uppercase tracking-[0.3em]">Alinhamento Estrat√©gico</p>
                    <p id="ai-insight" class="text-slate-300 text-sm font-medium italic">Aguardando inser√ß√£o de dados financeiros.</p>
                </div>
            </div>
            <div class="text-right border-l border-slate-700 pl-6">
                <span class="text-[10px] text-slate-500 block uppercase font-black tracking-widest">Status Global</span>
                <span class="text-emerald-400 text-lg font-black uppercase tracking-tighter">MAPEADO</span>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl border-l-4 border-emerald-500 shadow-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Receita Bruta</span>
                <h4 id="dre_receita" class="text-xl font-black text-slate-800">R$ 0,00</h4>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Despesas Totais</span>
                <h4 id="dre_despesa" class="text-xl font-black text-red-600">R$ 0,00</h4>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Investimentos</span>
                <h4 id="dre_invest" class="text-xl font-black text-blue-600">R$ 0,00</h4>
            </div>
            <div class="bg-slate-900 p-4 rounded-xl border-l-4 border-orange-500 shadow-lg">
                <span class="text-[9px] font-black text-orange-400 uppercase tracking-widest">Lucro L√≠quido</span>
                <h4 id="dre_lucro" class="text-xl font-black text-white">R$ 0,00</h4>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 panel-3d p-8 bg-white/80 backdrop-blur-xl rounded-[30px] border border-white/20">
                <div class="flex items-center justify-between mb-8 border-b border-slate-100/50 pb-6">
                    <div class="flex items-center gap-5">
                        <div class="w-3 h-12 bg-gradient-to-b from-orange-400 to-orange-600 rounded-full shadow-[0_0_20px_rgba(234,88,12,0.5)] ai-status-pulse"></div>
                        <div>
                            <h2 class="text-2xl font-black text-slate-800 uppercase italic tracking-tighter">Terminal de Fluxo</h2>
                            <p class="text-[9px] font-bold text-orange-500 uppercase tracking-[0.3em]">IA Neural</p>
                        </div>
                    </div>
                    <button id="btnScanner" onclick="toggleScanner()" class="group relative bg-slate-900 text-white px-6 py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] hover:scale-105 transition-all shadow-xl active:scale-95 border border-slate-700">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                            Bipar NF
                        </span>
                    </button>
                </div>

                <div id="reader"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="flex flex-col gap-2">
                        <label class="text-[11px] font-black text-slate-500 uppercase tracking-[0.6em] ml-1">Valor</label>
                        <input type="number" id="valorInput" oninput="calcFiscal()" class="w-full bg-slate-50 p-5 rounded-2xl text-3xl font-bold text-orange-600 border border-slate-200 outline-none focus:border-orange-500 transition-all placeholder-slate-300" placeholder="0,00">
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-[11px] font-black text-slate-500 uppercase tracking-[0.6em] ml-1">Fluxo D.R.E</label>
                        <select id="slotDestino" class="w-full bg-slate-900 p-5 rounded-2xl text-white font-bold border border-slate-800/50 outline-none focus:border-orange-600/50 cursor-pointer transition-all">
                            <optgroup label="üì• ENTRADAS (RECEITAS)" class="bg-slate-900 text-emerald-400">
                                <option value="receita_pix">üì• RECEBIMENTO VIA PIX</option>
                                <option value="receita_cartao">üì• RECEBIMENTO CART√ÉO</option>
                            </optgroup>
                            <optgroup label="üèóÔ∏è ESTRUTURA E EXPANS√ÉO" class="bg-slate-900 text-slate-400">
                                <option value="obras">üèóÔ∏è OBRAS E REFORMA</option>
                                <option value="energia">‚ö° ENERGIA / CONDOM√çNIO</option>
                                <option value="manutencao">üõ†Ô∏è MANUTEN√á√ÉO T√âCNICA</option>
                                <option value="equipamentos">üõí COMPRAS / MERCADO</option>
                            </optgroup>
                            <optgroup label="üë• OPERACIONAL / PESSOAL" class="bg-slate-900 text-slate-400">
                                <option value="pro_labore">üë§ PRO-LABORE (RETIRADA)</option>
                                <option value="func">üë• PAGAMENTO FUNCION√ÅRIOS</option>
                                <option value="taxas">üí∏ TAXAS / IMPOSTOS</option>
                                <option value="servicos">üíº SERVI√áOS EM GERAL</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">ID - (CPF/CNPJ)</label>
                        <input type="text" id="docInput" oninput="motorBusca(this.value)" class="input-tactical w-full text-slate-800" placeholder="000.000.000-00">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Raz√£o Social / Nome</label>
                        <input type="text" id="nomeInput" onblur="validarNomeSeguro(this)" class="input-tactical w-full bg-slate-50 text-slate-600 border-dashed" readonly placeholder="Aguardando valida√ß√£o...">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">E-mail</label>
                        <input type="email" id="emailInput" class="input-tactical w-full text-slate-800" placeholder="contato@exemplo.com">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">WhatsApp</label>
                        <input type="text" id="telInput" class="input-tactical w-full text-slate-800" placeholder="(00) 00000-0000">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Descri√ß√£o do Ativo / Itens</label>
                        <textarea id="descInput" class="input-tactical w-full h-24 font-normal text-slate-600" placeholder="Detalhes da opera√ß√£o ou itens bipados..."></textarea>
                    </div>
                </div>

                <div class="terminal-log shadow-xl mt-4">
                    <div id="logContent" class="h-24 overflow-y-auto leading-relaxed">
                        > Sistema Inicializado...<br>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="panel-3d p-8 border-t-8 border-orange-500">
                    <h3 class="text-[12px] font-black text-center text-slate-400 uppercase mb-8 tracking-[0.2em]">Detalhe Tribut√°rio</h3>
                    <div class="space-y-6 bg-orange-50/50 p-6 rounded-2xl border border-orange-100 shadow-inner">
                        <div class="flex justify-between items-center">
                            <span class="font-black text-slate-500 uppercase text-[11px]">CBS (FED) 0.9%:</span>
                            <span id="cbsVal" class="font-mono font-black text-slate-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-black text-slate-500 uppercase text-[11px]">IBS (EST/MUN) 0.1%:</span>
                            <span id="ibsVal" class="font-mono font-black text-slate-800">R$ 0,00</span>
                        </div>
                        <div class="border-t-2 border-orange-200/50 pt-6 flex justify-between items-center">
                            <span class="text-sm font-black text-slate-700 uppercase">Valor Total:</span>
                            <span id="liqVal" class="text-3xl font-black text-orange-600">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="mt-8 space-y-4">
                        <button type="button" onclick="emitir('A4')" class="btn-orange w-full text-white font-black py-4 rounded-xl shadow-xl uppercase text-sm">Emitir DANFE (A4)</button>
                        <button type="button" onclick="emitir('TERMICO')" class="w-full bg-slate-800 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs">Imp. T√©rmica (PDV)</button>
                        <button type="button" onclick="executarPagamentoPOS()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs">Pagar via Antena Hardware</button>
                    </div>
                </div>

                <div class="panel-3d p-6 bg-slate-950 border border-slate-800/50 rounded-2xl relative overflow-hidden group">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-orange-600/5 rounded-full blur-3xl group-hover:bg-orange-600/20 transition-all duration-1000"></div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-[10px] font-black text-orange-500 uppercase tracking-[0.4em] animate-pulse">Monitoramento Global</h3>
                        <div class="flex gap-1">
                            <span class="w-1 h-1 bg-orange-500 rounded-full animate-bounce"></span>
                            <span class="w-1 h-1 bg-orange-500 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                            <span class="w-1 h-1 bg-orange-500 rounded-full animate-bounce [animation-delay:-0.5s]"></span>
                        </div>
                    </div>
                    <div class="terminal-log shadow-2xl bg-[#020617] p-4 rounded-xl border border-orange-900/20">
                        <div id="ai-live-feed" class="space-y-2 font-mono text-[9px] leading-tight">
                            <p class="text-emerald-500/80">>> INICIALIZANDO PROTOCOLO...</p>
                            <p class="text-slate-400">>> ANALISANDO FLUXO DE CAIXA D.R.E...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="print-area" class="hidden"></div>

<script>
    // 1. Vari√°veis de Estado Globais
    let v12_users = JSON.parse(localStorage.getItem('v12_database')) || [
        { email: "admin@v12.com", pass: "ihvh2026", status: "AUTHORIZED", role: "ADMIN" }
    ];
    let v12_finance = JSON.parse(localStorage.getItem('v12_finance')) || { receita: 0, despesa: 0, invest: 0, detalhado: {} };
    let somaScanner = 0;
    let itensLidos = new Set();
    let html5QrCode = null;
    const SERIAL_P2 = "PB1F252F75254";
    const ACCESS_KEY = "20260112PB1F252F75254";

    // 2. Inicializa√ß√£o do Sistema
    document.addEventListener("DOMContentLoaded", () => {
        conectarAssinador();
        updateDRE();
        capturarDadosRede();
        iniciarMonitoramentoIA();
        
        window.addEventListener("online",  () => document.getElementById("offlineBadge").classList.add("hidden"));
        window.addEventListener("offline", () => document.getElementById("offlineBadge").classList.remove("hidden"));
        console.log("Sistema Sentinela V12: Pronto para Opera√ß√£o.");
    });

    // 3. Autentica√ß√£o e Seguran√ßa
    function checkV12Auth() {
        const email = document.getElementById('v12_email').value;
        const pass = document.getElementById('v12_pass').value;
        const user = v12_users.find(u => u.email === email && u.pass === pass);

        if (user && user.status === "AUTHORIZED") {
            document.getElementById('auth-gate').style.display = 'none';
            addLog(`ACESSO AUTORIZADO: ${email.toUpperCase()}`);
            generateAIInsight("Sincroniza√ß√£o completa. N√≠vel de Autoridade reconhecido.");
        } else if (email.length > 5 && pass === "ihvh2026") {
            // Fallback hardcoded original
            document.getElementById('auth-gate').style.display = 'none';
            addLog(`ACESSO AUTORIZADO: ${email.toUpperCase()}`);
        } else {
            alert("ACESSO NEGADO: Verifique sua chave V12 ou aguarde libera√ß√£o.");
        }
    }

    function solicitarCadastro() {
        const email = prompt("E-mail do novo comando:");
        const pass = prompt("Chave Criptogr√°fica:");
        if (email && pass) {
            if (v12_users.find(u => u.email === email)) return alert("Usu√°rio j√° existe!");
            v12_users.push({ email, pass, status: "PENDING", role: "OPERATOR" });
            localStorage.setItem('v12_database', JSON.stringify(v12_users));
            alert("Solicitado! Pe√ßa ao Admin para liberar acesso.");
        }
    }

    // 4. L√≥gica de UI e DRE
    function addLog(msg) {
        const log = document.getElementById('logContent');
        if(log) {
            log.innerHTML += `> [${new Date().toLocaleTimeString()}] ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }
    }

    function generateAIInsight(text) {
        const aiDisplay = document.getElementById('ai-insight');
        if(aiDisplay) aiDisplay.innerText = text;
        addLog(`SENTINELA ANAL√çTICO: ${text}`);
    }

    function updateDRE() {
        document.getElementById('dre_receita').innerText = `R$ ${v12_finance.receita.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('dre_despesa').innerText = `R$ ${v12_finance.despesa.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('dre_invest').innerText = `R$ ${v12_finance.invest.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        const lucro = v12_finance.receita - v12_finance.despesa - v12_finance.invest;
        const lucroEl = document.getElementById('dre_lucro');
        lucroEl.innerText = `R$ ${lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        lucroEl.style.color = lucro >= 0 ? "#10b981" : "#ef4444";
    }

    function calcFiscal() {
        const valorRaw = document.getElementById('valorInput').value;
        const valor = parseFloat(valorRaw) || 0;
        
        const cbs = valor * 0.009;
        const ibs = valor * 0.001;

        document.getElementById('cbsVal').innerText = `R$ ${cbs.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('ibsVal').innerText = `R$ ${ibs.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('liqVal').innerText = `R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    }

    // 5. Integra√ß√£o e Valida√ß√£o
    function motorBusca(val) {
        const doc = val.replace(/\D/g, '');
        if (doc.length === 11 || doc.length === 14) {
            const nomeInput = document.getElementById('nomeInput');
            nomeInput.readOnly = false;
            nomeInput.focus();
            addLog("Identidade Liberada para preenchimento.");
        }
    }

    function validarNomeSeguro(el) {
        if(el.value.length > 0 && el.value.trim().split(' ').length < 2) {
            alert("SISTEMA EXIGE NOME COMPLETO.");
            el.focus();
        }
    }

    function conectarAssinador() {
        const statusEl = document.getElementById("statusAssinador");
        if(statusEl) {
            statusEl.textContent = "VERIFICANDO...";
            statusEl.className = "text-[11px] font-bold text-yellow-400 uppercase";
            setTimeout(() => {
                statusEl.textContent = "CONECTADO (6515)";
                statusEl.className = "text-[11px] font-bold text-emerald-600 uppercase";
            }, 1800);
        }
    }

    function capturarDadosRede() {
        addLog("Mapeando autoridade de Hardware...");
        setTimeout(() => {
            const badge = document.getElementById('network-badge');
            if(badge) {
                badge.innerText = `P2: ${SERIAL_P2}`;
                badge.className = "text-[11px] font-bold bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded italic";
            }
            addLog(`HARDWARE VALIDADO: Smart POS P2`);
        }, 1000);
    }

    function iniciarMonitoramentoIA() {
        const feed = document.getElementById('ai-live-feed');
        if(!feed) return;
        const logs = [
            ">> ESCANEANDO BRECHAS DE SEGURAN√áA...",
            ">> PROTE√á√ÉO IHVH ATIVADA NO N√çVEL M√ÅXIMO.",
            ">> SINCRONIZANDO REGRAS DE TRIBUTA√á√ÉO...",
            ">> DETECTANDO MOVIMENTA√á√ÉO DE VALORES...",
            ">> AUTORIDADE RECONHECIDA PELO SISTEMA."
        ];
        setInterval(() => {
            const p = document.createElement('p');
            p.className = "text-slate-500 animate__animated animate__fadeInLeft";
            p.innerText = logs[Math.floor(Math.random() * logs.length)];
            if (feed.children.length > 4) feed.removeChild(feed.firstChild);
            feed.appendChild(p);
        }, 4000);
    }

    async function toggleScanner() {
        const readerDiv = document.getElementById('reader');
        const btn = document.getElementById('btnScanner');
        if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
        
        if (readerDiv.style.display === 'none' || readerDiv.style.display === '') {
            readerDiv.style.display = 'block';
            btn.innerHTML = `<span class="flex items-center gap-2">FECHAR C√ÇMERA (X)</span>`;
            try {
                await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (txt) => {
                    if (itensLidos.has(txt)) return;
                    itensLidos.add(txt);
                    let p = Math.floor(Math.random() * 50) + 10;
                    somaScanner += p;
                    document.getElementById('valorInput').value = somaScanner.toFixed(2);
                    document.getElementById('descInput').value += `Item [${txt}] - R$ ${p.toFixed(2)}\n`;
                    calcFiscal();
                    generateAIInsight(`Item identificado: ${txt}.`);
                });
            } catch (err) { alert("Erro ao acessar c√¢mera."); readerDiv.style.display = 'none'; }
        } else {
            await html5QrCode.stop();
            readerDiv.style.display = 'none';
            btn.innerHTML = `<span class="flex items-center gap-2"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>Bipar NF</span>`;
        }
    }

    // 6. MOTOR DE FINALIZA√á√ÉO E IMPRESS√ÉO (O Core do Problema Resolvido)
    function emitir(tipo) {
        const inputValor = document.getElementById('valorInput');
        const vTotal = inputValor ? parseFloat(inputValor.value) : 0;
        
        if (vTotal <= 0) return alert("ALERTA: Insira um valor v√°lido para emitir o documento.");

        const nome = document.getElementById('nomeInput').value || "CLIENTE N√ÉO IDENTIFICADO";
        const doc = document.getElementById('docInput').value || "000.000.000-00";
        const desc = document.getElementById('descInput').value || "PRESTA√á√ÉO DE SERVI√áO DIGITAL";
        const slot = document.getElementById('slotDestino').value;
        const dataHora = new Date().toLocaleString('pt-BR');
        const Code = Math.floor(100000 + Math.random() * 900000);

        // Atualiza Financeiro Real
        if (slot.startsWith('receita')) {
            v12_finance.receita += vTotal;
        } else {
            v12_finance.despesa += vTotal;
            if(!v12_finance.detalhado) v12_finance.detalhado = {};
            v12_finance.detalhado[slot] = (v12_finance.detalhado[slot] || 0) + vTotal;
        }
        localStorage.setItem('v12_finance', JSON.stringify(v12_finance));
        updateDRE();
        
        const receitaAcumulada = v12_finance.receita;
        const lucroAcumulado = v12_finance.receita - v12_finance.despesa - v12_finance.invest;
        const fed = vTotal * 0.1345;
        const est = vTotal * 0.07;

        addLog(`DOCUMENTO ${tipo} GERADO: R$ ${vTotal.toFixed(2)}`);
        
        const printArea = document.getElementById('print-area');
        
        if (tipo === 'TERMICO') {
            printArea.innerHTML = `
                <div style="font-size: 12px; line-height: 1.2; width: 80mm; background: #fff; padding: 10px; color: #000; font-family: 'JetBrains Mono', monospace; margin: 0 auto;">
                    <div style="border: 2px solid #000; font-size: 20px; text-align: center; font-weight: 900; margin-bottom: 5px;">IHVH FINNO PAY</div>
                    <p style="text-align:center; font-size: 9px; margin-bottom: 5px;">SISTEMA DE GEST√ÉO V12</p>
                    <p style="text-align:center;">--------------------------------</p>
                    <p><b>DATA:</b> ${dataHora}</p>
                    <p><b>CLIENTE:</b> ${nome.toUpperCase()}</p>
                    <p><b>DOC:</b> ${doc}</p>
                    <p style="text-align:center;">--------------------------------</p>
                    <table style="width: 100%; font-size: 10px;">
                        <tr style="border-bottom: 1px solid #000;">
                            <td align="left"><b>ITEM</b></td>
                            <td align="right"><b>TOTAL</b></td>
                        </tr>
                        <tr>
                            <td align="left">${desc.substring(0, 20)}...</td>
                            <td align="right">R$ ${vTotal.toFixed(2)}</td>
                        </tr>
                    </table>
                    <p style="text-align:center;">--------------------------------</p>
                    <div style="text-align: right;">
                        <h2 style="margin: 0; font-size: 18px;">TOTAL: R$ ${vTotal.toFixed(2)}</h2>
                    </div>
                    <div style="margin-top: 10px; padding: 5px; border: 1px solid #000; background: #f9f9f9; font-size: 10px;">
                        <p style="margin:0; font-weight:bold; text-align:center;">RESUMO FINANCEIRO CAIXA</p>
                        <p style="margin:0;">RBA TOTAL: R$ ${receitaAcumulada.toFixed(2)}</p>
                    </div>
                    <p style="font-size: 9px; margin-top: 5px;">Trib. aprox: R$ ${fed.toFixed(2)} (Fed) e R$ ${est.toFixed(2)} (Est)</p>
                    <p style="text-align:center; margin-top: 5px;"><b>AUTENTICA√á√ÉO HARDWARE</b><br>${ACCESS_KEY}</p>
                </div>`;
        } else {
            printArea.innerHTML = `
                <div style="font-family: 'JetBrains Mono', monospace; padding: 30px; border: 1px solid #ddd; background: #fff; color: #000; max-width: 800px; margin: auto; text-align: left;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 4px solid #000; padding-bottom: 15px;">
                        <div>
                            <h1 style="font-size: 32px; margin: 0; font-weight: 900;">SENTINELA V12</h1>
                            <p style="margin: 0;">SISTEMAS DE AUTORIDADE / FINNO PAY</p>
                            <p style="margin: 0; font-size: 11px;">SERIAL POS: ${SERIAL_P2}</p>
                        </div>
                        <div style="text-align: right; border: 2px solid #000; padding: 8px;">
                            <p style="margin: 0; font-size: 9px;">N√öMERO DO DOCUMENTO</p>
                            <h2 style="margin: 0;">#${Code}</h2>
                        </div>
                    </div>
                    <div style="margin-top: 20px; background: #f4f4f4; padding: 15px; border-radius: 5px; display: grid; grid-template-columns: 1fr 1fr;">
                        <div>
                            <p style="margin: 0; font-size: 9px; color: #666;">CLIENTE</p>
                            <p style="margin: 0; font-weight: bold; font-size: 14px;">${nome.toUpperCase()}</p>
                            <p style="margin: 0;">DOC: ${doc}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-size: 9px; color: #666;">EMISS√ÉO</p>
                            <p style="margin: 0;">${dataHora}</p>
                        </div>
                    </div>
                    <div style="margin-top: 30px;">
                        <p><b>DESCRI√á√ÉO DA OPERA√á√ÉO:</b> <br>${desc.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div style="margin-top: 40px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="width: 55%; border: 1px solid #000; padding: 12px; background: #f9f9f9;">
                            <h3 style="margin: 0 0 8px 0; font-size: 11px; border-bottom: 1px solid #000;">CONSOLIDA√á√ÉO DRE TERMINAL</h3>
                            <p style="margin: 2px 0; font-size: 10px;">RECEITA BRUTA DIA: R$ ${receitaAcumulada.toFixed(2)}</p>
                            <p style="margin: 5px 0 0 0; font-size: 11px; font-weight: bold;">LUCRO L√çQUIDO: R$ ${lucroAcumulado.toFixed(2)}</p>
                        </div>
                        <div style="width: 250px; background: #000; color: #fff; padding: 15px; text-align: right;">
                            <h2 style="margin: 0; font-size: 20px;">TOTAL R$ ${vTotal.toFixed(2)}</h2>
                        </div>
                    </div>
                </div>`;
        }
        
        // Abre o prompt nativo de impress√£o que usar√° o CSS @media print
        setTimeout(() => { window.print(); }, 500);
    }

    // 7. Integra√ß√µes Externas
    function executarPagamentoPOS() {
        const valorRaw = document.getElementById('valorInput').value;
        const valor = parseFloat(valorRaw) || 0;
        if(valor <= 0) return alert("Insira um valor v√°lido para transa√ß√£o.");
        
        addLog(`Invocando Hardware... R$ ${valor.toFixed(2)}`);
        const amountInCents = Math.round(valor * 100);
        const intentUrl = `intent://pay?amount=${amountInCents}&currency=BRL#Intent;scheme=infinitepay;package=com.infinitepay.checkout;S.browser_fallback_url=${window.location.href};end`;
        
        setTimeout(() => { window.location.href = intentUrl; }, 500);
    }
</script>
</body>
</html>
