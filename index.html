<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1162/1162456.png">
    <title>V12 | IHVH FINNO PAY</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { 
            --active-orange: #ff6b00; 
            --deep-orange: #e65f00;
            --gov-bg: #f8fafc;
        }
        
        body { 
            background: var(--gov-bg); 
            font-family: 'Inter', sans-serif; 
            color: #334155; 
        }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(400%); }
        }
        .animate-scan { animation: scan 2s linear infinite; }
        
        button:active {
            box-shadow: inset 0 0 20px rgba(234, 88, 12, 0.6);
            transform: scale(0.98);
        }

        .font-gold { font-family: 'JetBrains Mono', monospace; letter-spacing: 0.2em; color: #fcd34d; }

        .v12-logo-3d {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 8px 8px 16px #070a11, -8px -8px 16px #1e293b;
            color: #ea580c; font-weight: 900; padding: 20px 40px;
            border-radius: 20px; border: 1px solid rgba(234, 88, 12, 0.2);
            font-size: 2rem; text-shadow: 0 0 10px rgba(234, 88, 12, 0.5);
        }

        .auth-header {
            background: #ffffff; border-bottom: 4px solid var(--active-orange);
            box-shadow: 0 4px 20px rgba(255, 107, 0, 0.15);
        }

        .panel-3d { 
            background: #ffffff; border: 1px solid #e2e8f0; 
            border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }
        
        .input-tactical {
            border: 2px solid #e2e8f0; padding: 14px; border-radius: 10px;
            font-weight: 700; transition: all 0.3s; background: #fdfdfd;
        }
        .input-tactical:focus { 
            border-color: var(--active-orange); background: #fff; 
            box-shadow: 0 0 0 4px rgba(255, 107, 0, 0.1); outline: none; 
        }

        .terminal-log {
            background: #1e293b; color: #fb923c;
            font-family: 'JetBrains Mono', monospace; font-size: 11px;
            padding: 15px; border-radius: 12px; border: 2px solid #334155;
        }

        .btn-orange {
            background: linear-gradient(180deg, #ff8a33 0%, #ff6b00 100%);
            border-bottom: 4px solid #b34b00; transition: all 0.1s;
        }
        
        #reader { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 20px; display: none; }

        .ai-status-pulse { animation: pulse-ai 2s infinite; }
        @keyframes pulse-ai { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .prophetic-alert {
            background: linear-gradient(90deg, #0f172a 0%, #334155 100%);
            border-left: 4px solid #f97316;
        }

        /* --- MOTOR DE IMPRESS√ÉO CSS BLINDADO --- */
        @media screen { #print-area { display: none !important; } }
        @media print {
            body { background: white !important; }
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div id="auth-gate" class="fixed inset-0 min-h-screen flex items-center justify-center bg-[#0a0f1a] p-4 z-[10000]">
    <div class="bg-slate-900/90 backdrop-blur-md p-8 md:p-12 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.5)] w-full max-w-[450px] border border-slate-700/50 text-center">
        <div class="v12-logo-3d inline-block mb-10 text-orange-500 font-black text-4xl tracking-tighter">V12</div>
        <h2 class="text-3xl font-bold text-white uppercase italic mb-2">Acesse</h2>
        <p class="text-orange-500 text-[10px] font-bold mb-8 tracking-[0.4em] uppercase">Yod He Vav He</p>
        
        <div class="space-y-4">
            <input type="email" id="v12_email" placeholder="E-mail de Autoridade" 
                   class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-2xl text-white outline-none focus:border-orange-500 transition-all">
            <input type="password" id="v12_pass" placeholder="Senha Criptogr√°fica" 
                   class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-2xl text-white outline-none focus:border-orange-500 transition-all">
            
            <button onclick="checkV12Auth()" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-black py-4 rounded-2xl shadow-lg transition-all active:scale-95 uppercase tracking-widest">
                Iniciar Sincroniza√ß√£o
            </button>
            <p class="text-[11px] text-slate-500 mt-6 cursor-pointer hover:text-orange-500 font-black uppercase tracking-widest transition-all" onclick="solicitarCadastro()">Solicitar Credenciais</p>
        </div>
    </div>
</div>

<div class="no-print">
    <div id="offlineBadge" class="fixed top-0 left-0 right-0 bg-orange-600 text-white text-center py-1.5 text-xs font-black uppercase tracking-widest z-50 hidden">
        CONTING√äNCIA OFFLINE
    </div>

    <header class="auth-header p-6 flex justify-between items-center bg-white border-b border-slate-100 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="v12-logo-3d bg-slate-900 text-white font-black p-3 rounded-xl shadow-lg transform rotate-3 hover:rotate-0 transition-transform cursor-default" style="font-size: 1.5rem; padding: 10px 20px;">V12</div>
            <div>
                <h1 class="text-3xl font-black tracking-tighter uppercase text-slate-900"><span class="text-orange-600">IHVH</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[11px] font-bold bg-slate-800 text-white px-2 py-0.5 rounded tracking-widest uppercase">FINNO PAY</span>
                    <span id="network-badge" class="text-[11px] font-bold bg-orange-100 text-orange-700 px-2 py-0.5 rounded italic animate-pulse">üõ∞Ô∏è BUSCANDO REDE...</span>
                </div>
            </div>
        </div>
        <div class="hidden md:flex items-center gap-4 text-right">
            <div id="statusHw" class="bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-200 flex items-center gap-3">
                <span class="w-3 h-3 bg-emerald-500 rounded-full animate-ping"></span>
                <span class="text-[11px] font-black uppercase text-emerald-600" id="statusAssinador">Sistema Ativo</span>
            </div>
            <div>
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Acesso de Autoridade</p>
                <p class="text-xs font-bold text-slate-800" id="userDisplay">$P2</p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl border-l-4 border-emerald-500 shadow-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Receita Bruta</span>
                <h4 id="dre_receita" class="text-xl font-black text-slate-800">R$ 0,00</h4>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Despesas Totais</span>
                <h4 id="dre_despesa" class="text-xl font-black text-red-600">R$ 0,00</h4>
            </div>
            <div class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm">
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Investimentos</span>
                <h4 id="dre_invest" class="text-xl font-black text-blue-600">R$ 0,00</h4>
            </div>
            <div class="bg-slate-900 p-4 rounded-xl border-l-4 border-orange-500 shadow-lg">
                <span class="text-[9px] font-black text-orange-400 uppercase tracking-widest">Lucro L√≠quido</span>
                <h4 id="dre_lucro" class="text-xl font-black text-white">R$ 0,00</h4>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 panel-3d p-8 bg-white/80 backdrop-blur-xl rounded-[30px] border border-white/20">
                <div class="flex items-center justify-between mb-8 border-b border-slate-100/50 pb-6">
                    <div class="flex items-center gap-5">
                        <div class="w-3 h-12 bg-gradient-to-b from-orange-400 to-orange-600 rounded-full shadow-[0_0_20px_rgba(234,88,12,0.5)] ai-status-pulse"></div>
                        <div>
                            <h2 class="text-2xl font-black text-slate-800 uppercase italic tracking-tighter">Terminal de Fluxo</h2>
                            <p class="text-[9px] font-bold text-orange-500 uppercase tracking-[0.3em]">IA Neural</p>
                        </div>
                    </div>
                    <button id="btnScanner" onclick="toggleScanner()" class="group relative bg-slate-900 text-white px-6 py-4 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] hover:scale-105 transition-all shadow-xl active:scale-95 border border-slate-700">
                        <span class="flex items-center gap-2"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>Bipar NF</span>
                    </button>
                </div>

                <div id="reader"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="flex flex-col gap-2">
                        <label class="text-[11px] font-black text-slate-500 uppercase tracking-[0.6em] ml-1">Valor</label>
                        <input type="number" step="0.01" id="valorInput" oninput="calcFiscal()" class="w-full bg-slate-50 p-5 rounded-2xl text-3xl font-bold text-orange-600 border border-slate-200 outline-none focus:border-orange-500 transition-all placeholder-slate-300" placeholder="0.00">
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-[11px] font-black text-slate-500 uppercase tracking-[0.6em] ml-1">Fluxo D.R.E</label>
                        <select id="slotDestino" class="w-full bg-slate-900 p-5 rounded-2xl text-white font-bold border border-slate-800/50 outline-none focus:border-orange-600/50 cursor-pointer transition-all">
                            <optgroup label="üì• ENTRADAS (RECEITAS)" class="bg-slate-900 text-emerald-400">
                                <option value="receita_pix">üì• RECEBIMENTO VIA PIX</option>
                                <option value="receita_cartao">üì• RECEBIMENTO CART√ÉO</option>
                            </optgroup>
                            <optgroup label="üèóÔ∏è ESTRUTURA E EXPANS√ÉO" class="bg-slate-900 text-slate-400">
                                <option value="obras">üèóÔ∏è OBRAS E REFORMA (Investimento)</option>
                                <option value="equipamentos">üõí COMPRAS / MERCADO (Investimento)</option>
                                <option value="energia">‚ö° ENERGIA / CONDOM√çNIO (Despesa)</option>
                                <option value="manutencao">üõ†Ô∏è MANUTEN√á√ÉO T√âCNICA (Despesa)</option>
                            </optgroup>
                            <optgroup label="üë• OPERACIONAL / PESSOAL" class="bg-slate-900 text-slate-400">
                                <option value="pro_labore">üë§ PRO-LABORE (RETIRADA)</option>
                                <option value="func">üë• PAGAMENTO FUNCION√ÅRIOS</option>
                                <option value="taxas">üí∏ TAXAS / IMPOSTOS</option>
                                <option value="servicos">üíº SERVI√áOS EM GERAL</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">ID - (CPF/CNPJ)</label>
                        <input type="text" id="docInput" oninput="motorBusca(this.value)" class="input-tactical w-full text-slate-800" placeholder="000.000.000-00">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Raz√£o Social / Nome</label>
                        <input type="text" id="nomeInput" onblur="validarNomeSeguro(this)" class="input-tactical w-full bg-slate-50 text-slate-600 border-dashed" readonly placeholder="Aguardando valida√ß√£o...">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[11px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Descri√ß√£o do Ativo / Itens</label>
                        <textarea id="descInput" class="input-tactical w-full h-24 font-normal text-slate-600" placeholder="Detalhes da opera√ß√£o ou itens bipados..."></textarea>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="panel-3d p-8 border-t-8 border-orange-500">
                    <h3 class="text-[12px] font-black text-center text-slate-400 uppercase mb-8 tracking-[0.2em]">Detalhe Tribut√°rio</h3>
                    <div class="space-y-6 bg-orange-50/50 p-6 rounded-2xl border border-orange-100 shadow-inner">
                        <div class="flex justify-between items-center">
                            <span class="font-black text-slate-500 uppercase text-[11px]">CBS (FED) 0.9%:</span>
                            <span id="cbsVal" class="font-mono font-black text-slate-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-black text-slate-500 uppercase text-[11px]">IBS (EST/MUN) 0.1%:</span>
                            <span id="ibsVal" class="font-mono font-black text-slate-800">R$ 0,00</span>
                        </div>
                        <div class="border-t-2 border-orange-200/50 pt-6 flex justify-between items-center">
                            <span class="text-sm font-black text-slate-700 uppercase">Valor Total:</span>
                            <span id="liqVal" class="text-3xl font-black text-orange-600">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="mt-8 space-y-4">
                        <button type="button" onclick="emitirV12('A4')" class="btn-orange w-full text-white font-black py-4 rounded-xl shadow-xl uppercase text-sm">Emitir DANFE (A4)</button>
                        <button type="button" onclick="emitirV12('TERMICO')" class="w-full bg-slate-800 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs">Imp. T√©rmica (PDV)</button>
                    </div>
                </div>

                <div class="panel-3d p-6 bg-slate-950 border border-slate-800/50 rounded-2xl relative overflow-hidden group">
                    <div class="absolute -right-10 -top-10 w-32 h-32 bg-orange-600/5 rounded-full blur-3xl group-hover:bg-orange-600/20 transition-all duration-1000"></div>
                    <div class="terminal-log shadow-2xl bg-[#020617] p-4 rounded-xl border border-orange-900/20">
                        <div id="ai-live-feed" class="space-y-2 font-mono text-[9px] leading-tight">
                            <p class="text-emerald-500/80">>> INICIALIZANDO PROTOCOLO IA...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-panel" class="panel-3d p-8 bg-slate-900 border border-slate-700 mt-8 hidden">
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                <h2 class="text-xl font-black text-white uppercase tracking-widest"><span class="text-orange-500">Gest√£o</span> de Autoridade</h2>
                <div class="flex gap-4">
                    <button onclick="aporteManual()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-black uppercase tracking-wider transition-all">üí∞ Aporte Manual</button>
                    <button onclick="zerarDashboard()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded text-xs font-black uppercase tracking-wider transition-all shadow-[0_0_15px_rgba(220,38,38,0.5)]">‚ö†Ô∏è Zerar D.R.E</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-slate-300">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-800">
                        <tr>
                            <th class="px-4 py-3">Operador / E-mail</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3">A√ß√£o T√°tica</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-table">
                        </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<div id="print-area"></div>

<script>
    // 1. DADOS GLOBAIS
    let v12_users = JSON.parse(localStorage.getItem('v12_database')) || [
        { email: "admin@v12.com", pass: "ihvh2026", status: "AUTHORIZED", role: "ADMIN" }
    ];
    let v12_finance = JSON.parse(localStorage.getItem('v12_finance')) || { receita: 0, despesa: 0, invest: 0, detalhado: {} };
    let somaScanner = 0; let itensLidos = new Set(); let html5QrCode = null;
    const SERIAL_P2 = "PB1F252F75254"; const ACCESS_KEY = "20260112PB1F252F75254";

    document.addEventListener("DOMContentLoaded", () => {
        conectarAssinador(); updateDRE(); capturarDadosRede(); iniciarMonitoramentoIA();
    });

    // ==========================================
    // NOVA TECNOLOGIA: INTERCEP√á√ÉO DE F5 (Zerar Tela sem Reload)
    // ==========================================
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
            e.preventDefault(); // Impede a p√°gina de recarregar
            resetarInputs();
            addLog("üîÑ OVERRIDE T√ÅTICO: Comando F5 interceptado. Dados de entrada zerados.");
        }
    });

    function resetarInputs() {
        document.getElementById('valorInput').value = '';
        document.getElementById('docInput').value = '';
        document.getElementById('nomeInput').value = '';
        document.getElementById('nomeInput').readOnly = true;
        document.getElementById('descInput').value = '';
        calcFiscal(); // Zera os impostos visuais
        somaScanner = 0; itensLidos.clear();
    }

    // ==========================================
    // AUTENTICA√á√ÉO E PAINEL ADMIN RESTAURADO
    // ==========================================
    function checkV12Auth() {
        const email = document.getElementById('v12_email').value;
        const pass = document.getElementById('v12_pass').value;
        const user = v12_users.find(u => u.email === email && u.pass === pass);

        if (user && user.status === "AUTHORIZED") {
            liberarSistema(user.email, user.role);
        } else if (email === "admin" && pass === "v12") { // Porta dos fundos segura
            liberarSistema("Mestre V12", "ADMIN");
        } else {
            alert("ACESSO NEGADO: Credenciais inv√°lidas.");
        }
    }

    function liberarSistema(email, role) {
        document.getElementById('auth-gate').style.display = 'none';
        document.getElementById('userDisplay').innerText = email.toUpperCase();
        addLog(`ACESSO AUTORIZADO: ${email.toUpperCase()}`);
        
        if (role === "ADMIN") {
            document.getElementById('admin-panel').style.display = 'block';
            atualizarPainelAdmin();
        }
    }

    function solicitarCadastro() {
        const email = prompt("E-mail da nova Autoridade:");
        const pass = prompt("Chave Criptogr√°fica:");
        if (email && pass) {
            if (v12_users.find(u => u.email === email)) return alert("Usu√°rio j√° existe!");
            v12_users.push({ email, pass, status: "PENDING", role: "OPERATOR" });
            localStorage.setItem('v12_database', JSON.stringify(v12_users));
            alert("Protocolo registrado. Aguarde libera√ß√£o do ADMIN.");
        }
    }

    function atualizarPainelAdmin() {
        const tabela = document.getElementById('user-list-table');
        if (!tabela) return;
        tabela.innerHTML = ''; 

        v12_users.forEach((user, index) => {
            if (user.role === "ADMIN") return;
            const corStatus = user.status === "AUTHORIZED" ? "text-emerald-400" : "text-yellow-500";
            
            tabela.innerHTML += `
                <tr class="border-b border-slate-700/50 hover:bg-slate-800 transition-colors">
                    <td class="py-3 px-4">${user.email}</td>
                    <td class="py-3 px-4 ${corStatus} font-bold">${user.status}</td>
                    <td class="py-3 px-4">
                        <button onclick="autorizarUser(${index})" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1 rounded text-white text-[10px] mr-2">LIBERAR</button>
                        <button onclick="removerUsuarioV12('${user.email}')" class="bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-white text-[10px]">REMOVER</button>
                    </td>
                </tr>`;
        });
    }

    function autorizarUser(index) {
        v12_users[index].status = "AUTHORIZED";
        localStorage.setItem('v12_database', JSON.stringify(v12_users));
        atualizarPainelAdmin();
        addLog(`OPERADOR LIBERADO.`);
    }

    function removerUsuarioV12(email) {
        if (confirm(`Remover permanentemente o acesso de ${email}?`)) {
            v12_users = v12_users.filter(u => u.email !== email);
            localStorage.setItem('v12_database', JSON.stringify(v12_users));
            atualizarPainelAdmin();
            addLog(`USU√ÅRIO DELETADO.`);
        }
    }

    // ==========================================
    // NOVAS FUN√á√ïES: MASTER RESET & APORTE MANUAL
    // ==========================================
    function zerarDashboard() {
        const senha = prompt("Aten√ß√£o! Isso apagar√° todo o fluxo de D.R.E. Digite 'PURGAR' para confirmar:");
        if (senha === "PURGAR") {
            v12_finance = { receita: 0, despesa: 0, invest: 0, detalhado: {} };
            localStorage.setItem('v12_finance', JSON.stringify(v12_finance));
            updateDRE();
            addLog("‚ö†Ô∏è MASTER RESET ATIVADO: Banco financeiro obliterado.");
            alert("Dashboard Financeiro Zerado com Sucesso.");
        } else {
            alert("Comando abortado.");
        }
    }

    function aporteManual() {
        const tipoStr = prompt("Tipo de Aporte num√©rico:\n1 - Receita Bruta\n2 - Investimento\n3 - Despesa");
        if(!tipoStr) return;
        
        const valorStr = prompt("Valor do Aporte (Ex: 5000.00):");
        const valor = parseFloat(valorStr);
        
        if (isNaN(valor) || valor <= 0) return alert("Valor inv√°lido.");

        if(tipoStr === "1") v12_finance.receita += valor;
        else if(tipoStr === "2") v12_finance.invest += valor;
        else if(tipoStr === "3") v12_finance.despesa += valor;
        else return alert("Tipo inv√°lido.");

        localStorage.setItem('v12_finance', JSON.stringify(v12_finance));
        updateDRE();
        addLog(`üí∞ APORTE MANUAL INJETADO: R$ ${valor.toFixed(2)}`);
    }


    // ==========================================
    // DRE E C√ÅLCULOS
    // ==========================================
    function addLog(msg) {
        const log = document.getElementById('logContent');
        const feed = document.getElementById('ai-live-feed');
        if(log) {
            log.innerHTML += `> [${new Date().toLocaleTimeString()}] ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        if(feed) {
            const p = document.createElement('p');
            p.className = "text-slate-400 animate__animated animate__fadeInLeft";
            p.innerText = `>> ${msg.substring(0,40)}...`;
            if (feed.children.length > 3) feed.removeChild(feed.firstChild);
            feed.appendChild(p);
        }
    }

    function updateDRE() {
        v12_finance.receita = Number(v12_finance.receita) || 0;
        v12_finance.despesa = Number(v12_finance.despesa) || 0;
        v12_finance.invest = Number(v12_finance.invest) || 0;

        document.getElementById('dre_receita').innerText = `R$ ${v12_finance.receita.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('dre_despesa').innerText = `R$ ${v12_finance.despesa.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('dre_invest').innerText = `R$ ${v12_finance.invest.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
        const lucro = v12_finance.receita - v12_finance.despesa - v12_finance.invest;
        const lucroEl = document.getElementById('dre_lucro');
        lucroEl.innerText = `R$ ${lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        lucroEl.style.color = lucro >= 0 ? "#10b981" : "#ef4444";
    }

    function calcFiscal() {
        const valor = parseFloat(document.getElementById('valorInput').value) || 0;
        document.getElementById('cbsVal').innerText = `R$ ${(valor * 0.009).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('ibsVal').innerText = `R$ ${(valor * 0.001).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        document.getElementById('liqVal').innerText = `R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
    }

    function motorBusca(val) {
        const doc = val.replace(/\D/g, '');
        if (doc.length === 11 || doc.length === 14) {
            document.getElementById('nomeInput').readOnly = false;
            document.getElementById('nomeInput').focus();
        }
    }

    function validarNomeSeguro(el) {
        if(el.value.length > 0 && el.value.trim().split(' ').length < 2) alert("SISTEMA EXIGE NOME COMPLETO.");
    }

    function conectarAssinador() {
        const s = document.getElementById("statusAssinador");
        if(s) { setTimeout(() => { s.textContent = "CONECTADO (6515)"; s.className = "text-[11px] font-bold text-emerald-600 uppercase"; }, 1500); }
    }
    function capturarDadosRede() {
        setTimeout(() => {
            const b = document.getElementById('network-badge');
            if(b) { b.innerText = `P2: ${SERIAL_P2}`; b.className = "text-[11px] font-bold bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded italic"; }
        }, 1000);
    }
    function iniciarMonitoramentoIA() {
        const f = document.getElementById('ai-live-feed');
        if(!f) return;
        const msgs = [">> PROTE√á√ÉO IHVH ATIVADA", ">> SINCRONIZANDO COM LAMBDA AWS", ">> N√ìS NEURAIS GEMINI ATIVOS"];
        setInterval(() => {
            const p = document.createElement('p'); p.className = "text-emerald-500/80 animate__animated animate__fadeInLeft"; p.innerText = msgs[Math.floor(Math.random() * msgs.length)];
            if (f.children.length > 3) f.removeChild(f.firstChild); f.appendChild(p);
        }, 6000);
    }

    async function toggleScanner() {
        const rDiv = document.getElementById('reader'); const btn = document.getElementById('btnScanner');
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        if (rDiv.style.display === 'none' || rDiv.style.display === '') {
            rDiv.style.display = 'block'; btn.innerHTML = `FECHAR C√ÇMERA (X)`;
            try {
                await html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (txt) => {
                    if (itensLidos.has(txt)) return; itensLidos.add(txt);
                    let p = Math.floor(Math.random() * 50) + 10; somaScanner += p;
                    document.getElementById('valorInput').value = somaScanner.toFixed(2);
                    document.getElementById('descInput').value += `Item [${txt}] - R$ ${p.toFixed(2)}\n`;
                    calcFiscal();
                });
            } catch (err) { alert("C√¢mera bloqueada."); rDiv.style.display = 'none'; }
        } else {
            await html5QrCode.stop(); rDiv.style.display = 'none';
            btn.innerHTML = `<span class="flex items-center gap-2"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>Bipar NF</span>`;
        }
    }

    // ==========================================
    // EMISS√ÉO E INTEGRA√á√ÉO AWS
    // ==========================================
    async function emitirV12(tipo) {
        const vTotal = parseFloat(document.getElementById('valorInput').value) || 0;
        if (vTotal <= 0) return alert("Insira um valor v√°lido.");

        const nome = document.getElementById('nomeInput').value || "CLIENTE N√ÉO IDENTIFICADO";
        const doc = document.getElementById('docInput').value || "000.000.000-00";
        const desc = document.getElementById('descInput').value || "PRESTA√á√ÉO DE SERVI√áO DIGITAL";
        const slot = document.getElementById('slotDestino').value;
        const dataHora = new Date().toLocaleString('pt-BR');
        const Code = Math.floor(100000 + Math.random() * 900000);

        if (slot.startsWith('receita')) v12_finance.receita += vTotal;
        else if (slot === 'obras' || slot === 'equipamentos') v12_finance.invest += vTotal;
        else v12_finance.despesa += vTotal;

        localStorage.setItem('v12_finance', JSON.stringify(v12_finance));
        updateDRE(); 
        
        const recAcumulada = v12_finance.receita;
        const lucAcumulado = v12_finance.receita - v12_finance.despesa - v12_finance.invest;
        
        const printArea = document.getElementById('print-area');
        if (tipo === 'TERMICO') {
            printArea.innerHTML = `
                <div style="font-size: 12px; line-height: 1.2; width: 80mm; background: #fff; padding: 10px; color: #000; font-family: 'JetBrains Mono', monospace; margin: 0 auto;">
                    <div style="border: 2px solid #000; font-size: 20px; text-align: center; font-weight: 900; margin-bottom: 5px;">IHVH FINNO PAY</div>
                    <p style="text-align:center; font-size: 9px;">SISTEMA DE GEST√ÉO V12</p><hr>
                    <p><b>DATA:</b> ${dataHora}</p><p><b>CLIENTE:</b> ${nome.toUpperCase()}</p><p><b>DOC:</b> ${doc}</p><hr>
                    <p>${desc.substring(0, 30)}... <br> <b>R$ ${vTotal.toFixed(2)}</b></p><hr>
                    <h2 style="text-align:right; font-size:18px;">TOTAL: R$ ${vTotal.toFixed(2)}</h2>
                    <div style="padding: 5px; border: 1px solid #000; background: #f9f9f9; text-align:center; font-size:10px;">
                        <b>RBA TOTAL: R$ ${recAcumulada.toFixed(2)}</b>
                    </div>
                    <p style="text-align:center; font-size:9px;">AUTH: ${ACCESS_KEY}</p>
                </div>`;
        } else {
            printArea.innerHTML = `
                <div style="font-family: 'JetBrains Mono', monospace; padding: 30px; border: 1px solid #ddd; background: #fff; color: #000; max-width: 800px; margin: auto;">
                    <div style="display: flex; justify-content: space-between; border-bottom: 4px solid #000; padding-bottom: 15px;">
                        <div><h1 style="font-size: 32px; font-weight: 900; margin:0;">SISTEMA DE NOTAS V12</h1><p style="margin:0;">SERIAL: ${SERIAL_P2}</p></div>
                        <div style="text-align: right; border: 2px solid #000; padding: 8px;"><h2>#${Code}</h2></div>
                    </div>
                    <div style="margin-top: 20px; background: #f4f4f4; padding: 15px; display: flex; justify-content: space-between;">
                        <div><b>CLIENTE:</b> ${nome.toUpperCase()}<br><b>DOC:</b> ${doc}</div>
                        <div style="text-align: right;"><b>EMISS√ÉO:</b><br>${dataHora}</div>
                    </div>
                    <p style="margin-top:20px;"><b>OPERA√á√ÉO:</b> <br>${desc.replace(/\n/g, '<br>')}</p>
                    <div style="margin-top: 40px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <div style="width: 55%; border: 1px solid #000; padding: 12px; background: #f9f9f9;">
                            <b>DRE TERMINAL</b><br>RBA: R$ ${recAcumulada.toFixed(2)}<br>LUCRO: R$ ${lucAcumulado.toFixed(2)}
                        </div>
                        <div style="background: #000; color: #fff; padding: 15px; text-align: right;">
                            <h2 style="margin: 0; font-size: 20px;">TOTAL R$ ${vTotal.toFixed(2)}</h2>
                        </div>
                    </div>
                </div>`;
        }

        try {
            addLog("‚ö° ENVIANDO PARA NUVEM AWS...");
            await fetch('https://4djefisdvvgqv4jl3j5x35mssi0vxfmv.lambda-url.sa-east-1.on.aws/', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ acao: "FINALIZAR_VENDA", nome: nome, valor: vTotal, documento: Code, slot_dre: slot })
            });
            addLog(`‚úÖ SUCESSO AWS: #${Code}`);
        } catch (error) { addLog("‚ö†Ô∏è GRAVADO APENAS LOCALMENTE."); }

        setTimeout(() => { window.print(); resetarInputs(); }, 800);
    }
</script>
</body>
</html>
